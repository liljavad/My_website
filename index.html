<script defer>
    // --- FINAL, FULLY OPTIMIZED & RESPONSIVE SCRIPT ---

    // --- DOM Element Setup ---
    const body = document.body;
    const loginBox = document.getElementById('login-box');
    const passwordInput = document.getElementById('password');
    const emailInput = document.getElementById('email');
    const submitBtn = document.getElementById('submit-btn');
    const canvas = document.getElementById('particle-canvas');
    const ctx = canvas.getContext('2d');
    
    let particlesArray = [];
    let mouseMoveUpdateQueued = false;
    let resizeTimeout;

    // --- 🚀 Performance Manager ---
    const PerformanceManager = {
        level: 'HIGH',
        initialize: function() {
            const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
            if (prefersReducedMotion) {
                this.level = 'LOW';
                return;
            }
            const coreCount = navigator.hardwareConcurrency || 4;
            if (coreCount <= 4) {
                this.level = 'LOW';
            }
        }
    };
    PerformanceManager.initialize();
    body.classList.add(PerformanceManager.level === 'LOW' ? 'performance-low' : 'performance-high');

    // --- Mouse Move Handler ---
    window.addEventListener('mousemove', (e) => {
        if (mouseMoveUpdateQueued) return;
        mouseMoveUpdateQueued = true;
        requestAnimationFrame(() => {
            if (body.classList.contains('aurora-enabled')) {
                body.style.setProperty('--mouse-x', `${e.clientX}px`);
                body.style.setProperty('--mouse-y', `${e.clientY}px`);
            }
            if (body.classList.contains('tilt-enabled')) {
                const { clientX, clientY } = e;
                const { innerWidth, innerHeight } = window;
                const yRotation = 10 * ((clientX - innerWidth / 2) / innerWidth);
                const xRotation = -10 * ((clientY - innerHeight / 2) / innerHeight);
                loginBox.style.transform = `rotateY(${yRotation}deg) rotateX(${xRotation}deg)`;
            }
            mouseMoveUpdateQueued = false;
        });
    });

    // --- Settings & Theme Logic ---
    document.getElementById('theme-switcher').addEventListener('click', () => {
        const isDark = body.classList.toggle('theme-dark');
        body.classList.toggle('theme-light', !isDark);
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        setTimeout(initParticles, 50);
    });

    document.getElementById('settings-toggle').addEventListener('click', () => {
        document.getElementById('settings-panel').classList.toggle('visible');
    });

    const auroraToggle = document.getElementById('aurora-toggle');
    auroraToggle.addEventListener('change', () => body.classList.toggle('aurora-enabled', auroraToggle.checked));

    const tiltToggle = document.getElementById('tilt-toggle');
    tiltToggle.addEventListener('change', () => {
        body.classList.toggle('tilt-enabled', tiltToggle.checked);
        if (!tiltToggle.checked) loginBox.style.transform = '';
    });
    
    function setInitialState() {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        body.className = `theme-${savedTheme}`;
        body.classList.add(PerformanceManager.level === 'LOW' ? 'performance-low' : 'performance-high');
        auroraToggle.checked = true;
        tiltToggle.checked = true;
        body.classList.add('aurora-enabled', 'tilt-enabled');
    }

    // --- Simplified Form Logic ---
    function updateFormState() {
        const isEmailValid = emailInput.value.length > 0 && emailInput.checkValidity();
        const isPasswordValid = passwordInput.value.length > 5; // A basic check for password length
        submitBtn.classList.toggle('ready', isEmailValid && isPasswordValid);
    }
    
    passwordInput.addEventListener('input', updateFormState);
    emailInput.addEventListener('input', updateFormState);

    // --- Form Submission ---
    document.getElementById('login-form').addEventListener('submit', function(e) {
        e.preventDefault();
        if (!submitBtn.classList.contains('ready')) {
            loginBox.classList.add('shake');
            setTimeout(() => loginBox.classList.remove('shake'), 500);
            return;
        }
        submitBtn.classList.add('fly-away');
    });

    // --- ADAPTIVE Particle System ---
    class Particle {
        constructor(x,y,dirX,dirY,size,color){this.x=x;this.y=y;this.dirX=dirX;this.dirY=dirY;this.size=size;this.color=color;this.twinkleSpeed=Math.random()*0.05+0.01;this.alpha=Math.random();}
        draw(){ctx.beginPath();const g=ctx.createRadialGradient(this.x,this.y,0,this.x,this.y,this.size);g.addColorStop(0,`rgba(255,255,255,${this.alpha*.9})`);g.addColorStop(.4,`rgba(${this.color},${this.alpha*.7})`);g.addColorStop(1,`rgba(${this.color},0)`);ctx.fillStyle=g;ctx.arc(this.x,this.y,this.size,0,Math.PI*2,false);ctx.fill();}
        update(){if(this.x>canvas.width+this.size||this.x<0-this.size)this.dirX=-this.dirX;if(this.y>canvas.height+this.size||this.y<0-this.size)this.dirY=-this.dirY;this.alpha+=this.twinkleSpeed;if(this.alpha>1||this.alpha<0)this.twinkleSpeed*=-1;this.x+=this.dirX;this.y+=this.dirY;this.draw();}
    }
    function initParticles() {
        particlesArray=[];
        // 🚀 تعداد ذرات برای دستگاه ضعیف بسیار کمتر است
        const baseDensity = PerformanceManager.level === 'LOW' ? 90000 : 30000;
        let num=(canvas.width*canvas.height)/baseDensity;
        let color=getComputedStyle(body).getPropertyValue('--particle-color-rgb').trim();
        for(let i=0;i<num;i++){let size=Math.random()*3+1.5;let x=Math.random()*innerWidth;let y=Math.random()*innerHeight;let dirX=Math.random()*.2-.1;let dirY=Math.random()*.2-.1;particlesArray.push(new Particle(x,y,dirX,dirY,size,color));}
    }
    function animateParticles() {requestAnimationFrame(animateParticles);ctx.clearRect(0,0,innerWidth,innerHeight);for(let i=0;i<particlesArray.length;i++){particlesArray[i].update();}}
    
    // --- Utility Functions ---
    function setCanvasSize() { canvas.width=window.innerWidth; canvas.height=window.innerHeight; }
    // 🚀 بهینه‌سازی رویداد تغییر سایز صفحه برای جلوگیری از لگ
    window.addEventListener('resize', ()=>{
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
            setCanvasSize();
            initParticles();
        }, 250); // تنها پس از اتمام تغییر سایز، به‌روزرسانی می‌شود
    });
    function togglePassword(event){event.stopPropagation();const isPassword=passwordInput.type==="password";passwordInput.type=isPassword?"text":"password";document.getElementById('eye-icon').classList.toggle("fa-eye-slash",isPassword);document.getElementById('eye-icon').classList.toggle("fa-eye",!isPassword);}

    // --- Initial Load ---
    setInitialState();
    setCanvasSize();
    initParticles();
    animateParticles();
</script>
